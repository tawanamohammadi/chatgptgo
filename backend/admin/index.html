<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† - ChatGPT Go</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0a0a;
      color: #fafafa;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Login Form */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: #141414;
      border: 1px solid #27272a;
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
    }

    .login-box h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #22c55e;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      background: #0a0a0a;
      border: 1px solid #27272a;
      border-radius: 8px;
      color: #fafafa;
      font-size: 16px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #22c55e;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #22c55e;
      color: #000;
      width: 100%;
    }

    .btn-primary:hover {
      background: #16a34a;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }

    .btn-success { background: #22c55e; color: #000; }
    .btn-warning { background: #f59e0b; color: #000; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-info { background: #3b82f6; color: #fff; }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #27272a;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #22c55e;
      font-size: 24px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #141414;
      border: 1px solid #27272a;
      border-radius: 12px;
      padding: 20px;
    }

    .stat-card h3 {
      color: #a1a1aa;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #22c55e;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters select {
      padding: 10px 16px;
      background: #141414;
      border: 1px solid #27272a;
      border-radius: 8px;
      color: #fafafa;
      font-size: 14px;
      cursor: pointer;
    }

    .filters select:focus {
      outline: none;
      border-color: #22c55e;
    }

    /* Table */
    .table-container {
      background: #141414;
      border: 1px solid #27272a;
      border-radius: 12px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 16px;
      text-align: right;
      border-bottom: 1px solid #27272a;
    }

    th {
      background: #0a0a0a;
      font-weight: 600;
      color: #a1a1aa;
      font-size: 14px;
    }

    tr:hover {
      background: #1a1a1a;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending { background: #fbbf2420; color: #fbbf24; border: 1px solid #fbbf2440; }
    .status-awaiting_payment { background: #3b82f620; color: #3b82f6; border: 1px solid #3b82f640; }
    .status-paid { background: #22c55e20; color: #22c55e; border: 1px solid #22c55e40; }
    .status-processing { background: #8b5cf620; color: #8b5cf6; border: 1px solid #8b5cf640; }
    .status-completed { background: #10b98120; color: #10b981; border: 1px solid #10b98140; }
    .status-cancelled { background: #ef444420; color: #ef4444; border: 1px solid #ef444440; }
    .status-failed { background: #ef444420; color: #ef4444; border: 1px solid #ef444440; }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #141414;
      border: 1px solid #27272a;
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal h2 {
      margin-bottom: 20px;
      color: #22c55e;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      left: 20px;
      background: none;
      border: none;
      color: #a1a1aa;
      font-size: 24px;
      cursor: pointer;
    }

    .order-detail {
      margin-bottom: 15px;
    }

    .order-detail label {
      display: block;
      color: #a1a1aa;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .order-detail value {
      display: block;
      font-size: 16px;
    }

    /* Error/Success messages */
    .message {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .message.error {
      background: #ef444420;
      border: 1px solid #ef4444;
      color: #ef4444;
    }

    .message.success {
      background: #22c55e20;
      border: 1px solid #22c55e;
      color: #22c55e;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .table-container {
        overflow-x: auto;
      }

      table {
        min-width: 800px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
      }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <div class="login-box">
      <h1>ğŸ” Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†</h1>
      <div id="loginError" class="message error hidden"></div>
      <form id="loginForm">
        <div class="form-group">
          <label for="password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
        </div>
        <button type="submit" class="btn btn-primary">ÙˆØ±ÙˆØ¯</button>
      </form>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="container hidden">
    <header class="header">
      <h1>ğŸ“Š Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</h1>
      <div class="header-actions">
        <button class="btn btn-info btn-sm" onclick="loadOrders()">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        <button class="btn btn-danger btn-sm" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Ú©Ù„ Ø³ÙØ§Ø±Ø´Ø§Øª</h3>
        <div class="value" id="totalOrders">0</div>
      </div>
      <div class="stat-card">
        <h3>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
        <div class="value" id="pendingOrders">0</div>
      </div>
      <div class="stat-card">
        <h3>Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</h3>
        <div class="value" id="paidOrders">0</div>
      </div>
      <div class="stat-card">
        <h3>ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</h3>
        <div class="value" id="completedOrders">0</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <select id="statusFilter" onchange="loadOrders()">
        <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
        <option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
        <option value="awaiting_payment">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</option>
        <option value="paid">Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</option>
        <option value="processing">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´</option>
        <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
        <option value="cancelled">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
        <option value="failed">Ù†Ø§Ù…ÙˆÙÙ‚</option>
      </select>
    </div>

    <!-- Orders Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Ø´Ù†Ø§Ø³Ù‡</th>
            <th>Ù†Ø§Ù…</th>
            <th>Ø§ÛŒÙ…ÛŒÙ„</th>
            <th>Ù†ÙˆØ¹</th>
            <th>Ù…Ø¨Ù„Øº</th>
            <th>ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´</th>
            <th>ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª</th>
            <th>ØªØ§Ø±ÛŒØ®</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
        </thead>
        <tbody id="ordersTable">
          <tr>
            <td colspan="9" style="text-align: center; color: #a1a1aa;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div id="orderModal" class="modal-overlay">
    <div class="modal">
      <h2>Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´</h2>
      <div id="orderDetails"></div>
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <select id="newStatus" style="flex: 1; padding: 10px; background: #0a0a0a; border: 1px solid #27272a; border-radius: 8px; color: #fafafa;">
          <option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
          <option value="awaiting_payment">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</option>
          <option value="paid">Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</option>
          <option value="processing">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´</option>
          <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
          <option value="cancelled">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
          <option value="failed">Ù†Ø§Ù…ÙˆÙÙ‚</option>
        </select>
        <button class="btn btn-success btn-sm" onclick="updateOrderStatus()">Ø°Ø®ÛŒØ±Ù‡</button>
        <button class="btn btn-danger btn-sm" onclick="closeModal()">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let adminPassword = '';
    let currentOrderId = null;

    // Check if already logged in
    document.addEventListener('DOMContentLoaded', () => {
      const savedPassword = sessionStorage.getItem('adminPassword');
      if (savedPassword) {
        adminPassword = savedPassword;
        showAdminPanel();
      }
    });

    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch(`${API_URL}/api/orders`, {
          headers: {
            'x-admin-password': password
          }
        });

        if (response.ok) {
          adminPassword = password;
          sessionStorage.setItem('adminPassword', password);
          showAdminPanel();
        } else {
          showError('loginError', 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
        }
      } catch (error) {
        showError('loginError', 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
      }
    });

    function showAdminPanel() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      loadOrders();
    }

    function logout() {
      sessionStorage.removeItem('adminPassword');
      adminPassword = '';
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('password').value = '';
    }

    async function loadOrders() {
      const status = document.getElementById('statusFilter').value;
      const url = status ? `${API_URL}/api/orders?status=${status}` : `${API_URL}/api/orders`;

      try {
        const response = await fetch(url, {
          headers: {
            'x-admin-password': adminPassword
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load orders');
        }

        const data = await response.json();
        renderOrders(data.orders);
        updateStats(data.orders);
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersTable').innerHTML = `
          <tr><td colspan="9" style="text-align: center; color: #ef4444;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª</td></tr>
        `;
      }
    }

    function renderOrders(orders) {
      const tbody = document.getElementById('ordersTable');
      
      if (orders.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="9" style="text-align: center; color: #a1a1aa;">Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>
        `;
        return;
      }

      tbody.innerHTML = orders.map(order => `
        <tr>
          <td style="font-family: monospace; font-size: 12px;">${order.id.substring(0, 8)}...</td>
          <td>${order.firstName} ${order.lastName}</td>
          <td style="direction: ltr;">${order.email}</td>
          <td>${order.orderType === 'personal' ? 'Ø§ÛŒÙ…ÛŒÙ„ Ø´Ø®ØµÛŒ' : 'Ù¾ÛŒØ´â€ŒØ³Ø§Ø®ØªÙ‡'}</td>
          <td>${order.amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
          <td><span class="status-badge status-${order.status}">${getStatusLabel(order.status)}</span></td>
          <td><span class="status-badge status-${order.paymentStatus || 'pending'}">${order.paymentStatus || '-'}</span></td>
          <td>${new Date(order.createdAt).toLocaleDateString('fa-IR')}</td>
          <td class="actions">
            <button class="btn btn-info btn-sm" onclick="viewOrder('${order.id}')">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
            ${order.status === 'paid' ? `<button class="btn btn-success btn-sm" onclick="quickUpdate('${order.id}', 'completed')">ØªÚ©Ù…ÛŒÙ„</button>` : ''}
            ${order.status === 'pending' ? `<button class="btn btn-danger btn-sm" onclick="quickUpdate('${order.id}', 'cancelled')">Ù„ØºÙˆ</button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    function getStatusLabel(status) {
      const labels = {
        pending: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±',
        awaiting_payment: 'Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª',
        paid: 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡',
        processing: 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´',
        completed: 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
        cancelled: 'Ù„ØºÙˆ Ø´Ø¯Ù‡',
        failed: 'Ù†Ø§Ù…ÙˆÙÙ‚'
      };
      return labels[status] || status;
    }

    function updateStats(orders) {
      const allOrders = orders;
      document.getElementById('totalOrders').textContent = allOrders.length;
      document.getElementById('pendingOrders').textContent = allOrders.filter(o => o.status === 'pending' || o.status === 'awaiting_payment').length;
      document.getElementById('paidOrders').textContent = allOrders.filter(o => o.status === 'paid').length;
      document.getElementById('completedOrders').textContent = allOrders.filter(o => o.status === 'completed').length;
    }

    async function viewOrder(orderId) {
      try {
        const response = await fetch(`${API_URL}/api/orders/${orderId}`, {
          headers: {
            'x-admin-password': adminPassword
          }
        });

        if (!response.ok) throw new Error('Failed to load order');

        const data = await response.json();
        currentOrderId = orderId;
        
        const order = data.order;
        document.getElementById('orderDetails').innerHTML = `
          <div class="order-detail"><label>Ø´Ù†Ø§Ø³Ù‡</label><value>${order.id}</value></div>
          <div class="order-detail"><label>Ù†Ø§Ù…</label><value>${order.firstName} ${order.lastName}</value></div>
          <div class="order-detail"><label>Ø§ÛŒÙ…ÛŒÙ„</label><value style="direction: ltr;">${order.email}</value></div>
          <div class="order-detail"><label>Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</label><value>${order.orderType === 'personal' ? 'Ø§ÛŒÙ…ÛŒÙ„ Ø´Ø®ØµÛŒ' : 'Ù¾ÛŒØ´â€ŒØ³Ø§Ø®ØªÙ‡'}</value></div>
          ${order.invoiceLink ? `<div class="order-detail"><label>Ù„ÛŒÙ†Ú© ÙØ§Ú©ØªÙˆØ±</label><value><a href="${order.invoiceLink}" target="_blank" style="color: #22c55e;">${order.invoiceLink}</a></value></div>` : ''}
          ${order.phone ? `<div class="order-detail"><label>ØªÙ„ÙÙ†</label><value style="direction: ltr;">${order.phone}</value></div>` : ''}
          <div class="order-detail"><label>Ù…Ø¨Ù„Øº</label><value>${order.amount.toLocaleString()} ØªÙˆÙ…Ø§Ù† ${order.amountUSD ? `(${order.amountUSD} USD)` : ''}</value></div>
          <div class="order-detail"><label>ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´</label><value><span class="status-badge status-${order.status}">${getStatusLabel(order.status)}</span></value></div>
          <div class="order-detail"><label>ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª</label><value>${order.paymentStatus || '-'}</value></div>
          ${order.paymentUrl ? `<div class="order-detail"><label>Ù„ÛŒÙ†Ú© Ù¾Ø±Ø¯Ø§Ø®Øª</label><value><a href="${order.paymentUrl}" target="_blank" style="color: #22c55e;">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a></value></div>` : ''}
          <div class="order-detail"><label>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</label><value>${new Date(order.createdAt).toLocaleString('fa-IR')}</value></div>
          <div class="order-detail"><label>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</label><value>${new Date(order.updatedAt).toLocaleString('fa-IR')}</value></div>
        `;
        
        document.getElementById('newStatus').value = order.status;
        document.getElementById('orderModal').classList.add('active');
      } catch (error) {
        console.error('Error loading order:', error);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙØ§Ø±Ø´');
      }
    }

    async function updateOrderStatus() {
      const newStatus = document.getElementById('newStatus').value;
      
      try {
        const response = await fetch(`${API_URL}/api/orders/${currentOrderId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-password': adminPassword
          },
          body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) throw new Error('Failed to update order');

        closeModal();
        loadOrders();
      } catch (error) {
        console.error('Error updating order:', error);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÙØ§Ø±Ø´');
      }
    }

    async function quickUpdate(orderId, status) {
      if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ "${getStatusLabel(status)}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;

      try {
        const response = await fetch(`${API_URL}/api/orders/${orderId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-password': adminPassword
          },
          body: JSON.stringify({ status })
        });

        if (!response.ok) throw new Error('Failed to update order');

        loadOrders();
      } catch (error) {
        console.error('Error updating order:', error);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÙØ§Ø±Ø´');
      }
    }

    function closeModal() {
      document.getElementById('orderModal').classList.remove('active');
      currentOrderId = null;
    }

    function showError(elementId, message) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

    // Close modal on overlay click
    document.getElementById('orderModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    // Escape key to close modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
  </script>
</body>
</html>
